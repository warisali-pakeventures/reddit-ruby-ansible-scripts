---
- hosts: aws
  remote_user: root
  become: yes
  environment:
    RAILS_ENV: production
    RAILS_LOG_TO_STDOUT: true
    RAILS_SERVE_STATIC_FILES: true
    RAILS_MASTER_KEY: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      66373530313536333666316464643663363239353066346265653932333634646135316635343034
      3735646662613339646635656634376365306135323434340a666163316333323364303661613731
      38313332373738306436633233383464303237613266646161306164376330613038666538633933
      3938643762323264660a303536393536313936333236666534336239653135646266376432663962
      65616661636265613539623138613834393236663464323739303162343663393032623837343336
      3334353163393761396662363065646165623833663665396461
    SENDGRID_API_KEY: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      39663639343132623866336539383466656235346165353362303463333466376433313034636561
      3339333730646338313339643836663862623531383066390a313533393432666235323231623836
      36333761386236353030653365383030623265306632633437346435303831353535346131376432
      3363643766366364340a623465366164303635366561363030386632643633383864326138386233
      62303738636162383166343832373135353861346639313035366537633639626630356439373037
      39396264336164376538623634383739666533633331613030393639636235313764323832633163
      33643232326561323132323438626337376166333931303065643533386137343031376434613733
      35363963653531306131
  tasks:
    - name: Downloading Git Repo
      git:
        repo: https://github.com/warisali-pakeventures/reddit-ruby
        dest: ~/apps/reddit-ruby
    - name: Install Gem Packages
      shell: bin/bundle install > /tmp/ansible.log 2>&1
      args:
        chdir: ~/apps/reddit-ruby/
    - name: Install Yarn Packages
      shell: yarn install > /tmp/ansible.log 2>&1
      args:
        chdir: ~/apps/reddit-ruby/
    - name: Apply DB Migrations
      shell: bin/rails db:migrate > /tmp/ansible.log 2>&1
      args:
        chdir: ~/apps/reddit-ruby/
    - name: Precompile Assets
      shell: bin/rake assets:precompile  > /tmp/ansible.log 2>&1
      args:
        chdir: ~/apps/reddit-ruby/
    - name: Starting Rails Server
      shell: bin/rails s -d -b 0.0.0.0 -p 80 > /tmp/ansible.log 2>&1
      args:
        chdir: ~/apps/reddit-ruby/
